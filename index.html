<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Family Tree</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            touch-action: none;
        }

        #tree-container {
            width: 100%;
            height: 100vh;
            position: relative;
            cursor: grab;
            overflow: hidden;
            touch-action: none;
        }

        #tree-container.grabbing {
            cursor: grabbing;
        }

        #tree-canvas {
            position: absolute;
            transform-origin: 0 0;
            touch-action: none;
        }

        .person {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
            touch-action: none;
        }

        .person:hover {
            transform: scale(1.1);
            z-index: 20;
        }

        .person:active {
            transform: scale(1.1);
            z-index: 20;
        }

        .person-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background-size: cover;
            background-position: center;
            background-color: #9333ea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .person-name {
            margin-top: 8px;
            color: white;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 100px;
            font-size: 14px;
            background: rgba(102, 126, 234, 0.8);
            padding: 4px 10px;
            border-radius: 12px;
            white-space: nowrap;
            position: relative;
            z-index: 15;
        }

        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s;
            font-size: 14px;
            touch-action: manipulation;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        #person-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 999;
        }

        .modal-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background-size: cover;
            background-position: center;
            border: 4px solid #667eea;
            background-color: #9333ea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
        }

        .modal-info {
            margin: 10px 0;
        }

        .modal-info label {
            font-weight: 600;
            color: #667eea;
            display: block;
            margin-bottom: 4px;
        }

        .modal-info p {
            color: #333;
            word-wrap: break-word;
        }

        .close-btn {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            padding: 0 5px;
        }

        #zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            padding: 0;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            #controls {
                top: 10px;
                right: 10px;
                gap: 5px;
            }

            button {
                padding: 10px 16px;
                font-size: 12px;
            }

            #zoom-controls {
                bottom: 15px;
                right: 15px;
                gap: 8px;
            }

            .zoom-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            #person-modal {
                padding: 20px;
                width: 95%;
            }

            .person-circle {
                width: 70px;
                height: 70px;
            }

            .person-name {
                font-size: 12px;
                padding: 3px 8px;
            }
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="reset-view-btn">Reset View</button>
    </div>

    <div id="zoom-controls">
        <button class="zoom-btn" id="zoom-in">+</button>
        <button class="zoom-btn" id="zoom-out">âˆ’</button>
    </div>

    <div id="tree-container">
        <div id="tree-canvas"></div>
    </div>

    <div id="modal-overlay"></div>
    <div id="person-modal">
        <span class="close-btn" id="close-modal">&times;</span>
        <div class="modal-photo" id="modal-photo"></div>
        <div class="modal-info">
            <label>Name:</label>
            <p id="modal-name"></p>
        </div>
        <div class="modal-info">
            <label>Email:</label>
            <p id="modal-email"></p>
        </div>
        <div class="modal-info">
            <label>Phone:</label>
            <p id="modal-phone"></p>
        </div>
        <div class="modal-info">
            <label>Birthday:</label>
            <p id="modal-birthday"></p>
        </div>
        <div class="modal-info">
            <label>Notes:</label>
            <p id="modal-notes"></p>
        </div>
    </div>

    <script src="family-data.js"></script>
    <script>
        // Tree rendering
        const canvas = document.getElementById('tree-canvas');
        const container = document.getElementById('tree-container');
        
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let svgElement = null;

        // Touch support variables
        let lastTouchDistance = 0;
        let isMultiTouch = false;
        let touchStartTime = 0;
        let touchStartPos = { x: 0, y: 0 };
        const TAP_THRESHOLD = 200; // ms
        const TAP_DISTANCE_THRESHOLD = 10; // pixels

        // Couple definitions
        const couples = [
            // Example: { partner1: 1, partner2: 2 }
        ];

        function calculateLayout(person, x, y, generation = 0, processed = new Set()) {
            if (processed.has(person.id)) return;
            processed.add(person.id);
            
            person.x = x;
            person.y = y;
            person.generation = generation;
            
            // Check if this person is in a couple
            const couple = couples.find(c => c.partner1 === person.id || c.partner2 === person.id);
            
            if (couple) {
                const isPartner1 = couple.partner1 === person.id;
                const partnerId = isPartner1 ? couple.partner2 : couple.partner1;
                const partner = familyData.find(p => p.id === partnerId);
                
                if (partner && !processed.has(partner.id)) {
                    // Position partner next to this person
                    partner.x = x + 100;
                    partner.y = y;
                    partner.generation = generation;
                    processed.add(partner.id);
                }
            }
            
            // Layout children
            const children = familyData.filter(p => p.parents && p.parents.includes(person.id));
            
            if (children.length > 0) {
                const totalWidth = children.length * 150;
                const startX = x - (totalWidth / 2) + 75;
                const nextY = y + 200;
                
                children.forEach((child, index) => {
                    if (!processed.has(child.id)) {
                        calculateLayout(child, startX + (index * 150), nextY, generation + 1, processed);
                    }
                });
            }
        }

        function drawTree() {
            canvas.innerHTML = '';
            svgElement = null;
            
            const roots = familyData.filter(person => !person.parents || person.parents.length === 0);
            
            if (roots.length > 0) {
                const totalWidth = roots.length * 200;
                const startX = 200;
                
                const processed = new Set();
                roots.forEach((root, index) => {
                    calculateLayout(root, startX + (index * 200), 50, 0, processed);
                });
                
                // Draw connections first
                familyData.forEach(person => {
                    if (person.parents && person.parents.length > 0) {
                        person.parents.forEach(parentId => {
                            const parent = familyData.find(p => p.id === parentId);
                            if (parent) {
                                drawConnection(parent, person);
                            }
                        });
                    }
                });
                
                // Draw people on top
                familyData.forEach(person => drawPerson(person));
            }
        }

        function drawConnection(parent, child) {
            if (!svgElement) {
                svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svgElement.style.position = 'absolute';
                svgElement.style.top = '0';
                svgElement.style.left = '0';
                svgElement.style.width = '3000px';
                svgElement.style.height = '3000px';
                svgElement.style.pointerEvents = 'none';
                svgElement.style.overflow = 'visible';
                svgElement.style.zIndex = '-1';
                canvas.appendChild(svgElement);
            }
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            
            const x1 = parent.x + 40;
            const y1 = parent.y + 80;
            const x2 = child.x + 40;
            const y2 = child.y;
            
            const midY = (y1 + y2) / 2;
            const pathData = `M ${x1} ${y1} L ${x1} ${midY} L ${x2} ${midY} L ${x2} ${y2}`;
            
            path.setAttribute('d', pathData);
            path.setAttribute('stroke', 'white');
            path.setAttribute('stroke-width', '3');
            path.setAttribute('fill', 'none');
            path.setAttribute('opacity', '0.7');
            
            svgElement.appendChild(path);
        }

        function drawPerson(person) {
            const couple = couples.find(c => c.partner1 === person.id || c.partner2 === person.id);
            
            if (couple) {
                const isPartner1 = couple.partner1 === person.id;
                const partner = familyData.find(p => p.id === (isPartner1 ? couple.partner2 : couple.partner1));
                
                if (partner && isPartner1) {
                    drawCouple(person, partner);
                    return;
                } else if (partner && !isPartner1) {
                    return;
                }
            }
            
            const personDiv = document.createElement('div');
            personDiv.className = 'person';
            personDiv.style.left = person.x + 'px';
            personDiv.style.top = person.y + 'px';
            personDiv.dataset.personId = person.id;
            
            const circle = document.createElement('div');
            circle.className = 'person-circle';
            
            if (person.photo) {
                circle.style.backgroundImage = `url(${person.photo})`;
            } else {
                circle.textContent = person.name.charAt(0).toUpperCase();
            }
            
            const name = document.createElement('div');
            name.className = 'person-name';
            name.textContent = person.name;
            
            personDiv.appendChild(circle);
            personDiv.appendChild(name);
            
            // Add click/tap handler
            personDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                showPersonDetails(person);
            });
            
            canvas.appendChild(personDiv);
        }

        function drawCouple(person1, person2) {
            let bornIntoFamily = person1;
            let marriedIn = person2;
            
            if ((!person1.parents || person1.parents.length === 0) && person2.parents && person2.parents.length > 0) {
                bornIntoFamily = person2;
                marriedIn = person1;
            }
            
            const spouseDiv = document.createElement('div');
            spouseDiv.className = 'person';
            spouseDiv.style.left = marriedIn.x + 'px';
            spouseDiv.style.top = marriedIn.y + 'px';
            spouseDiv.dataset.personId = marriedIn.id;
            
            const spouseCircle = document.createElement('div');
            spouseCircle.className = 'person-circle';
            
            if (marriedIn.photo) {
                spouseCircle.style.backgroundImage = `url(${marriedIn.photo})`;
            } else {
                spouseCircle.textContent = marriedIn.name.charAt(0).toUpperCase();
            }
            
            const spouseName = document.createElement('div');
            spouseName.className = 'person-name';
            spouseName.textContent = marriedIn.name;
            
            spouseDiv.appendChild(spouseCircle);
            spouseDiv.appendChild(spouseName);
            spouseDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                showPersonDetails(marriedIn);
            });
            
            const familyDiv = document.createElement('div');
            familyDiv.className = 'person';
            familyDiv.style.left = bornIntoFamily.x + 'px';
            familyDiv.style.top = bornIntoFamily.y + 'px';
            familyDiv.dataset.personId = bornIntoFamily.id;
            
            const familyCircle = document.createElement('div');
            familyCircle.className = 'person-circle';
            
            if (bornIntoFamily.photo) {
                familyCircle.style.backgroundImage = `url(${bornIntoFamily.photo})`;
            } else {
                familyCircle.textContent = bornIntoFamily.name.charAt(0).toUpperCase();
            }
            
            const familyName = document.createElement('div');
            familyName.className = 'person-name';
            familyName.textContent = bornIntoFamily.name;
            
            familyDiv.appendChild(familyCircle);
            familyDiv.appendChild(familyName);
            familyDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                showPersonDetails(bornIntoFamily);
            });
            
            canvas.appendChild(spouseDiv);
            canvas.appendChild(familyDiv);
        }

        function showPersonDetails(person) {
            document.getElementById('modal-photo').style.backgroundImage = 
                person.photo ? `url(${person.photo})` : 'none';
            document.getElementById('modal-photo').textContent = 
                person.photo ? '' : person.name.charAt(0).toUpperCase();
            document.getElementById('modal-name').textContent = person.name;
            document.getElementById('modal-email').textContent = person.email || 'N/A';
            document.getElementById('modal-phone').textContent = person.phone || 'N/A';
            document.getElementById('modal-birthday').textContent = person.birthday || 'N/A';
            document.getElementById('modal-notes').textContent = person.notes || 'N/A';
            
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('person-modal').style.display = 'block';
        }

        function updateTransform() {
            canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }

        // Mouse event handlers
        container.addEventListener('mousedown', (e) => {
            if (e.target === container || e.target === canvas) {
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                container.classList.add('grabbing');
            }
        });

        container.addEventListener('mousemove', (e) => {
            if (isDragging) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }
        });

        container.addEventListener('mouseup', () => {
            isDragging = false;
            container.classList.remove('grabbing');
        });

        container.addEventListener('mouseleave', () => {
            isDragging = false;
            container.classList.remove('grabbing');
        });

        // Touch event handlers
        container.addEventListener('touchstart', (e) => {
            touchStartTime = Date.now();
            
            if (e.touches.length === 1) {
                // Single touch - pan
                const touch = e.touches[0];
                touchStartPos = { x: touch.clientX, y: touch.clientY };
                isDragging = true;
                startX = touch.clientX - translateX;
                startY = touch.clientY - translateY;
                isMultiTouch = false;
            } else if (e.touches.length === 2) {
                // Two finger touch - pinch to zoom
                e.preventDefault();
                isDragging = false;
                isMultiTouch = true;
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lastTouchDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
            }
        }, { passive: false });

        container.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1 && isDragging && !isMultiTouch) {
                // Single touch pan
                const touch = e.touches[0];
                translateX = touch.clientX - startX;
                translateY = touch.clientY - startY;
                updateTransform();
            } else if (e.touches.length === 2) {
                // Pinch to zoom
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                if (lastTouchDistance > 0) {
                    const delta = currentDistance / lastTouchDistance;
                    scale *= delta;
                    scale = Math.max(0.3, Math.min(3, scale));
                    updateTransform();
                }
                
                lastTouchDistance = currentDistance;
            }
        }, { passive: false });

        container.addEventListener('touchend', (e) => {
            const touchDuration = Date.now() - touchStartTime;
            
            if (e.touches.length === 0) {
                // Check if it was a quick tap on a person
                if (touchDuration < TAP_THRESHOLD && isDragging) {
                    const touch = e.changedTouches[0];
                    const distance = Math.hypot(
                        touch.clientX - touchStartPos.x,
                        touch.clientY - touchStartPos.y
                    );
                    
                    if (distance < TAP_DISTANCE_THRESHOLD) {
                        // It was a tap, check if we tapped on a person
                        const element = document.elementFromPoint(touch.clientX, touch.clientY);
                        if (element) {
                            const personDiv = element.closest('.person');
                            if (personDiv && personDiv.dataset.personId) {
                                const personId = parseInt(personDiv.dataset.personId);
                                const person = familyData.find(p => p.id === personId);
                                if (person) {
                                    showPersonDetails(person);
                                }
                            }
                        }
                    }
                }
                
                isDragging = false;
                isMultiTouch = false;
                lastTouchDistance = 0;
            } else if (e.touches.length === 1) {
                // Went from 2 touches to 1, reset for panning
                const touch = e.touches[0];
                startX = touch.clientX - translateX;
                startY = touch.clientY - translateY;
                lastTouchDistance = 0;
                isMultiTouch = false;
                isDragging = true;
            }
        });

        // Prevent default touch behaviors
        container.addEventListener('touchcancel', () => {
            isDragging = false;
            isMultiTouch = false;
            lastTouchDistance = 0;
        });

        // Mouse wheel zoom
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale *= delta;
            scale = Math.max(0.3, Math.min(3, scale));
            updateTransform();
        }, { passive: false });

        // Zoom button handlers
        document.getElementById('zoom-in').addEventListener('click', () => {
            scale *= 1.2;
            scale = Math.min(3, scale);
            updateTransform();
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            scale *= 0.8;
            scale = Math.max(0.3, scale);
            updateTransform();
        });

        document.getElementById('reset-view-btn').addEventListener('click', () => {
            scale = 1;
            translateX = container.offsetWidth / 2 - 200;
            translateY = 50;
            updateTransform();
        });

        // Modal close handlers
        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('person-modal').style.display = 'none';
        });

        document.getElementById('modal-overlay').addEventListener('click', () => {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('person-modal').style.display = 'none';
        });

        // Initialize
        translateX = container.offsetWidth / 2 - 200;
        translateY = 50;
        updateTransform();
        drawTree();

        // Recalculate on window resize
        window.addEventListener('resize', () => {
            translateX = container.offsetWidth / 2 - 200;
            translateY = 50;
            updateTransform();
        });
    </script>
</body>
</html>
